<!DOCTYPE mapper     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.kontur.layers.repository.ApplicationMapper">

    <select id="getApplication" resultType="io.kontur.layers.repository.model.Application">
        select id,
               show_all_public_layers as showAllPublicLayers,
               is_public              as isPublic,
               owner,
               name,
               sidebar_icon_url       as sidebarIconUrl,
               favicon_url            as faviconUrl
        from apps
        where id = #{appId};
    </select>

    <select id="getApplicationOwnedOrPublic" resultType="io.kontur.layers.repository.model.Application">
        select id,
               show_all_public_layers as showAllPublicLayers,
               is_public              as isPublic,
               owner,
               name,
               sidebar_icon_url       as sidebarIconUrl,
               favicon_url            as faviconUrl
        from apps
        where id = #{appId}
          and (owner = #{owner} or is_public);
    </select>

    <select id="insertApplication" resultType="io.kontur.layers.repository.model.Application">
        with ins as (INSERT INTO apps (id, show_all_public_layers, is_public, owner, name, sidebar_icon_url, favicon_url)
            VALUES (#{id}, ${showAllPublicLayers}, #{isPublic}, #{owner}, #{name}, #{sidebarIconUrl}, #{faviconUrl})
            RETURNING *)
        select id,
               show_all_public_layers as showAllPublicLayers,
               is_public              as isPublic,
               owner,
               name,
               sidebar_icon_url       as sidebarIconUrl,
               favicon_url            as faviconUrl
        from ins;
    </select>

    <select id="updateApplication" resultType="io.kontur.layers.repository.model.Application">
        with upd as (UPDATE apps SET (show_all_public_layers, is_public, name, sidebar_icon_url, favicon_url) =
                (${showAllPublicLayers}, #{isPublic}, #{name}, #{sidebarIconUrl}, #{faviconUrl}) WHERE id = #{id} and owner = #{owner}
            RETURNING *)
        select id,
               show_all_public_layers as showAllPublicLayers,
               is_public              as isPublic,
               owner,
               name,
               sidebar_icon_url       as sidebarIconUrl,
               favicon_url            as faviconUrl
        from upd;
    </select>

    <select id="deleteApplication" resultType="io.kontur.layers.repository.model.Application">
        with del as (delete from apps WHERE id = #{appId} and owner = #{owner}
            RETURNING *)
        select id,
               show_all_public_layers as showAllPublicLayers,
               is_public              as isPublic,
               owner,
               name,
               sidebar_icon_url       as sidebarIconUrl,
               favicon_url            as faviconUrl
        from del;
    </select>


</mapper>